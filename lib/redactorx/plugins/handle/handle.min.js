RedactorX.add("plugin","handle",{translations:{en:{print:{print:"Print"}}},defaults:{url:!1,start:1,trigger:"@"},subscribe:{"editor.keyup":function(t){!1!==this.opts.handle.url&&this._handle(t)}},start:function(){this.handleLen=this.opts.handle.start},stop:function(){this._hide()},_handle:function(t){var e=t.get("e"),i=e.which,s=e.ctrlKey||e.metaKey,n=this.app.keycodes;i===n.DELETE||i===n.ESC||i===n.SPACE||i===n.SHIFT||s||-1!==[37,38,39,40].indexOf(i)||(i===n.BACKSPACE&&(this.handleLen=this.handleLen-2,this.handleLen<=this.opts.handle.start&&this._hide()),this._emit())},_emit:function(){var t=new RegExp("^"+this.opts.handle.trigger);this.handleStr=this.app.selection.getText("before",this.handleLen+1),t.test(this.handleStr)&&(this.handleStr=this.handleStr.replace(this.opts.handle.trigger,""),this.handleLen++,this.handleLen-1>this.opts.handle.start&&this._load())},_isShown:function(){return this.$panel&&this.$panel.hasClass("open")},_load:function(){this.ajax.post({url:this.opts.handle.url,data:"handle="+this.handleStr,success:this._parse.bind(this)})},_parse:function(t){if(""!==t){var e="object"==typeof t?t:JSON.parse(t);this._build(e)}},_build:function(t){for(var e in this.data=t,this.$panel=this.app.$body.find("."+this.prefix+"-panel"),0===this.$panel.length?(this.$panel=this.dom("<div>").addClass(this.prefix+"-panel"),this.app.$body.append(this.$panel)):this.$panel.html(""),this._stopEvents(),this._startEvents(),t){var i=this.dom("<div>").addClass(this.prefix+"-panel-item"),s=this.dom("<a>").attr("href","#");s.html(t[e].item),s.attr("data-key",e),s.on("click",this._replace.bind(this)),i.append(s),this.$panel.append(i)}var n=this.app.$doc.scrollTop(),a=this.app.selection.getPosition();this.$panel.css({top:a.bottom+n+"px",left:a.left+"px"})},_replace:function(t){t.preventDefault(),t.stopPropagation();var e=this.dom(t.target).attr("data-key"),i=this.data[e].replacement;this.app.marker.insert("start");var s=this.app.marker.find("start");if(!1!==s){var n=this.dom(s),a=s.previousSibling,h=a.textContent,p=new RegExp("@"+this.handleStr+"$");h=h.replace(p,""),a.textContent=h,n.before(i),this.app.selection.restoreMarker(),this._hide()}},_reset:function(){this.handleStr=!1,this.handleLen=this.opts.handle.start,this.$panel=!1},_hide:function(t){var e=!1,i=t&&t.which,s=this.app.keycodes;t&&"click"!==t.type&&i!==s.ESC&&i!==s.ENTER&&i!==s.SPACE||(e=!0),e&&(this.$panel&&this.$panel.remove(),this._reset(),this._stopEvents())},_startEvents:function(){var t="click."+this.prefix+"-plugin-handle keydown."+this.prefix+"-plugin-handle";this.app.$doc.on(t,this._hide.bind(this)),this.app.editor.getEditor().on(t,this._hide.bind(this))},_stopEvents:function(){var t="."+this.prefix+"-plugin-handle";this.app.$doc.off(t),this.app.editor.getEditor().off(t)}});